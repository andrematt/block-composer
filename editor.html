<!DOCTYPE html>

<html>
<link rel="icon" href="./src/img/favicon.ico">
<head>
</head>

<body>



  <div class="site">

    <div class="header">
      <div class="toolbar">
        <div class="site-title-container">
          <h1>Block Rule Composer <i class="fas fa-puzzle-piece"></i></h1>
        </div>

        <div class="utility-buttons-container">
          <div class="user-content">

            <div id="logged-button-section">
              <span id="user-name"></span>
              
              <span id="google-signout" > 
                <a href="http://localhost:8080/index.html">Back to home</a>
              </span>
              <!--
            <button id="suggestor-drop" class="pure-button" type="button">
              Move hint to main
            </button>
            -->
              <button id="button-modal-export" class="pure-button" type="button">
                Export XML
              </button>
              <button id="button-modal-check" class="pure-button" type="button">
                Check rule
              </button>
              <button id="button-modal-new" class="pure-button" type="button">
                New rule
              </button>
              <button id="button-modal-save" class="pure-button" type="button">
                Save rule
              </button>
              <button data-micromodal-trigger="modal-2" id="button-modal-get" class="pure-button" type="button">
                Get rules
              </button>
            </div>
          </div>
          <!--
    <div class="login-logout-container">
      <span id="google-signin" class="g-signin2"></span>
      <span id="google-signout" hidden="true"><a id="google-signout-text" href=""></a></span>
    </div>
    -->

        </div>

      </div>
    </div>

    <div class="workspaces-container">
      <div id="main-workspace-div"></div>
      <div id="suggestion-workspace-div"></div>
    </div>

    <div class="support-container">

      <div class="textarea-container">
        <div class="textarea-div">
          <div id="textarea-suggestor">

            <div>
              <button id="suggestor-and" class="pure-button" type="button" disabled>
                AND
              </button>
            </div>
            <div>
              <button id="suggestor-or" class="pure-button" type="button" disabled>
                OR
              </button>
            </div>
            <div>
              <button id="suggestor-not" class="pure-button" type="button" disabled>
                NOT
              </button>
            </div>
            <div>
              <button id="suggestor-action" class="pure-button" type="button" disabled>
                ACTION
              </button>
            </div>
            <div>
              <button id="suggestor-sequential" class="pure-button" type="button" disabled>
                SEQUENTIAL
              </button>
            </div>
            <div>
              <button id="suggestor-parallel" class="pure-button" type="button" disabled>
                PARALLEL
              </button>
            </div>
          </div>
        </div>

        <div class="textarea-div">
          <div id="textarea-suggestion-expl"> </div>
        </div>

        <div class="textarea-div">
          <div id="textarea-alerts"></div>
        </div>

        <div class="textarea-div">
          <div id="textarea-connections-check"></div>
        </div>
      </div>

      <div class="change-type-div">

        <div class="pure-menu pure-menu-horizontal">
          <ul class="pure-menu-list">
            <li class="pure-menu-item">
              <a href="#" class="pure-menu-link" id="suggestor-step-by-step">Step-by-step</a>
            </li>
            <li class="pure-menu-item">
              <a href="#" class="pure-menu-link" id="suggestor-full-rule">Full rule</a>
            </li>
            <li class="pure-menu-item">
              <a href="#" class="pure-menu-link" id="suggestor-none">None</a>
            </li>
          </ul>
        </div>
        <div id="rec-type-text-div" class="rec-type-text">
          Recommendation type: step-by-step
        </div>
      </div>
    </div>
  </div>

  <xml id="toolbox" style="display: hidden">
    <category name="Rule blocks">
      <block type="rule"></block>
    </category>

    <category id="trigger_list" name="Trigger list">
    </category>

    <category name="Trigger operators">
      <block type="and"></block>
      <block type="or"></block>
    </category>

    <category name="Action list">
    </category>

    <category name="Action operators">
    </category>

  </xml>

  <xml id="startBlocks" style="visibility: hidden">
    <block type="rule" inline="false" x="20" y="20">
    </block>
  </xml>


  <!-- modal save rule form -->
  <div class="modal micromodal-slide" id="modal-1" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-1-title">
        <header class="modal__header">
          <h2 class="modal__title" id="modal-1-title">
            Save rule
          </h2>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
        </header>
        <main class="modal__content" id="modal-1-content">
          <form action="/my-handling-form-page" method="post">
            <div>
              <label for="rule_name">Rule name:</label>
              <input type="text" id="rule_name" name="rule_name" required>
            </div>
            <div>
              <label for="priority">Priority:</label>
              <input type="number" min="1" max="10" id="priority" name="priority">
            </div>
          </form>
        </main>
        <footer class="modal__footer">
          <button id="button-confirm-save" class="pure-button" data-micromodal-close
            aria-label="Save this rule">Save</button>
          <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
        </footer>
      </div>
    </div>
  </div>


  <!-- modal get rule form -->
  <div class="modal micromodal-slide" id="modal-2" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-2-title">
        <header class="modal__header">
          <h2 class="modal__title" id="modal-2-title">
            Get rule
          </h2>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
        </header>
        <main class="modal__content" id="modal-2-content">
          <div class="rule-list-container">
          <p id="rule_list">
          </p>
        </div>
        </main>
        <footer class="modal__footer">
          <button id="button-confirm-get" class="pure-button" data-micromodal-close
            aria-label="Get this rule">Get rule</button>
          <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
          <button id="button-delete" class="pure-button" data-micromodal-close aria-label="Delete this rule">Delete
            rule</button>
          <button id="button-export-all" class="pure-button" data-micromodal-close aria-label="Export all rules">Export all rules
            </button>
          <button id="button-activate" class="pure-button" data-micromodal-close
            aria-label="Activate this rule">Activate rule</button>
          <button id="button-deactivate" class="pure-button" data-micromodal-close
            aria-label="Deactivate this rule">Deactivate rule</button>
        </footer>
      </div>
    </div>
  </div>

  <!-- modal sequential rec explaination -->
  <div class="modal micromodal-slide" id="modal-3" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-3-title">
        <header class="modal__header">
          <h2 class="modal__title" id="modal-3-title">
            Sequential recommendation
          </h2>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
        </header>
        <main class="modal__content" id="modal-3-content">
          <p>
          </p>
        </main>

        <button class="pure-button" id="whatIfCPT_button">Save and re-score prediction</button>
        <div id="prediction_rescored_CPT"></div>
        <footer class="modal__footer">
          <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
        </footer>
      </div>
    </div>
  </div>

  <!-- modal full rule explaination -->
  <div class="modal micromodal-slide" id="modal-4" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-4-title">
        <header class="modal__header">
          <h2 class="modal__title" id="modal-4-title">
            Full recommendation
          </h2>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
        </header>
        <main class="modal__content" id="modal-4-content">
          <p> todo
          </p>
        </main>
        <footer class="modal__footer">
          <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
        </footer>
      </div>
    </div>
  </div>

  </div> 

  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css"
    integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="src/css/micromodal.css">
  <link rel="stylesheet" type="text/css" href="src/css/editor.css">
  <script src="node_modules/jquery/dist/jquery.js"></script>
  <script src="https://apis.google.com/js/platform.js"></script>
  <script src="node_modules/file-saver/dist/FileSaver.js"></script>
  <script src="https://kit.fontawesome.com/6f52fd3181.js"></script>
  <script src="node_modules/micromodal/dist/micromodal.js"></script>
  <script src="node_modules/blockly/blockly_compressed.js"></script>
  <script src="node_modules/blockly/javascript_compressed.js"></script>
  <script src="node_modules/blockly/msg/js/en.js"></script>
  <script src="node_modules/blockly/blocks/text.js"></script>
  <script src="node_modules/blockly/blocks/loops.js"></script>
  <script src="node_modules/blockly/blocks/logic.js"></script>
  <script src="node_modules/blockly/blocks/lists.js"></script>
  <script src="node_modules/blockly/blocks/colour.js"></script>
  <script src="node_modules/blockly/blocks/variables.js"></script>
  <script src="node_modules/blockly/blocks/variables_dynamic.js"></script>
  <script src="src/js/staticBlocks.js"></script>
  <script src="src/js/ML5/p5.min.js"></script>
  <script src="src/js/ML5/p5.dom.min.js"></script>
  <script src="src/js/ML5/ml5.min.js" type="text/javascript"></script>
  <script type="module" src="src/js/main.js"></script>
  <script src="src/js/dynamicBlocks.js"></script>
  <script type="module">
    import * as Login from './src/js/login.js';
    import {
      saveUserToLocal, checkRule, exportSuggestorRule, exportSuggestorDrop,
      getWorkspace, exportWorkspace, getRuleSuggestorStatus,
      changeRecommendationType, clearSuggestionWorkspace, ruleSuggestorManager,
      getLastBlock, newRule, exportAllRules
    } from './src/js/main.js';
    import {
      saveRuleInDB, getAllFromDB, getOneFromDB, deleteRule,
      activateRule, deactivateRule, getAllFromDBUser
    } from './src/js/database_functs.js';
    import { appendRulesList, getFullRule } from './src/js/dom_modifiers.js';
    import { manageSequentialModal } from './src/js/rs_modalWindows.js';
    import { changeRecTypeDiv } from './src/js/textarea_manager.js';
    MicroModal.init();

    /**
     * Aggiunge un parametro alla funzione assegnata al bottone button-modal-get 
     */
    function addArgsToFunct() {
      appendRulesList("rule_list");
    }

    /**
     * Controlla che il workspace sia nello stato corretto per il salvataggio
     * prima di mostrare la finestra modale di conferma salvataggio
     */
    function saveRuleWrapper() {
      let checkStatus = checkRule();
      if (checkStatus === "OK") {
        document.getElementById('textarea-alerts').innerHTML = "";
        document.getElementById('textarea-alerts').innerHTML = "Check: " + checkStatus + ", Saving";
        MicroModal.show('modal-1');
      }
      else {
        document.getElementById('textarea-alerts').innerHTML = "";
        document.getElementById('textarea-alerts').innerHTML = "Can't save: " + checkStatus;
      }
    }

    /**
     * Controlla che la regola attualmente nel workspace sia corretta 
     */
    function checkRuleWrapper() {
      let checkStatus = checkRule();
      document.getElementById('textarea-alerts').innerHTML = "";
      document.getElementById('textarea-alerts').innerHTML = "Check: " + checkStatus;
    }

    /**
     * Show the modal for rule explainations
     */
    function ModalSuggestorInfoWrapper() {
      let status = getRuleSuggestorStatus();
      if (status === "seq") {
        manageSequentialModal();
        MicroModal.show('modal-3');
      }
      else if (status === "full") {
        MicroModal.show('modal-4');
      }
      else {
        //shows a text in textarea-alerts saiyng: "no suggestions to explain";
      }
    }


    //const buttonUsername = document.getElementById("button-username");
    //buttonUsername.addEventListener("click", saveToLocalWrapper, false);

    //const suggestorRule = document.getElementById("suggestor-rule");
    //suggestorRule.addEventListener("click", exportSuggestorRule, false);

    //const suggestorDrop = document.getElementById("suggestor-drop");
    //suggestorDrop.addEventListener("click", exportSuggestorDrop, false);

    //const suggestorInfo = document.getElementById("suggestor-info");
    //suggestorInfo.addEventListener("click", showModalSuggestorInfoWrapper, false);

    const buttonSave = document.getElementById("button-modal-save");
    buttonSave.addEventListener("click", saveRuleWrapper, false);

    const buttonExport = document.getElementById("button-modal-export");
    buttonExport.addEventListener("click", exportWorkspace, false);

    const buttonCheck = document.getElementById("button-modal-check");
    buttonCheck.addEventListener("click", checkRuleWrapper, false);

    const buttonConfirmSave = document.getElementById("button-confirm-save");
    buttonConfirmSave.addEventListener("click", saveRuleInDB, false);

    const buttonGetAll = document.getElementById("button-modal-get");
    buttonGetAll.addEventListener("click", addArgsToFunct, false);

    const buttonExportAll = document.getElementById("button-export-all");
    buttonExportAll.addEventListener("click", exportAllRules, false);
    
    const buttonNew = document.getElementById("button-modal-new");
    buttonNew.addEventListener("click", newRule, false);

    const buttonGetOne = document.getElementById("button-confirm-get");
    buttonGetOne.addEventListener("click", getFullRule, false);

    const buttonDelete = document.getElementById("button-delete");
    buttonDelete.addEventListener("click", deleteRule, false);

    const buttonActivate = document.getElementById("button-activate");
    buttonActivate.addEventListener("click", activateRule, false);

    const buttonDeactivate = document.getElementById("button-deactivate");
    buttonDeactivate.addEventListener("click", deactivateRule, false);

    //const suggestorWhy = document.getElementById("suggestor-why");
    //suggestorWhy.addEventListener("click", modalSuggestorInfoWrapper, false);

    //const suggestorChange = document.getElementById("suggestor-change");
    //suggestorChange.addEventListener("click", suggestorTypeWrapper, false);

  </script>

</body>

</html>